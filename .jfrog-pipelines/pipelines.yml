resources:
  - name: test
    type: GitRepo
    configuration:
      gitProvider: deepak_git
      path: creepy-pirate/testim-check
      branches:
        include: "{{ gitBranch }}"

pipelines:
  - name: TestimPipeline
    configuration:
        environmentVariables:
          readOnly:
            BROWSER_NAME:
              default: 'chrome-99-mac'
              description: Choose browser for running tests
              values:
                - 'chrome-99-mac'
                - 'chrome-99-mac-prod'
                - 'ie-11-win'
                - 'edge-18-win'
                - 'safari-13-mac'
            TESTIM_PROJECT_NAME:
              default: 'website'
              description: Select the project to run tests from
              values:
                - 'website'
            TESTIM_LABEL:
              default: 'sanity'
              description: Run all tests comprising one of the mentioned labels
              allowCustom: true
              value:
                - 'sanity'
            TESTIM_BASE_URL:
              default: 'https://jfrog.info'
              description: Starting URL after browser opens
              allowCustom: true
              value:
                - 'https://jfrog.info'
            TESTIM_PARALLEL:
              default: 4
              description: How many tests should run in parallel
              allowCustom: true
              value:
                - 4
            TESTIM_GRID_HOST:
              default: 'hub-cloud.browserstack.com/wd/hub'
              description: Where to run the tests
              allowCustom: true
              value:
                - 'hub-cloud.browserstack.com/wd/hub'
            TESTIM_GRID_PORT:
              default: 4444
              description: Where to run the tests
              allowCustom: true
              value:
                - 4444
            TESTIM_BRANCH:
              default: 'master'
              description: Where to run the tests
              allowCustom: true
              value:
                - 'master'
            TESTIM_SELENIUM_MODE:
              default: false
              description: "When you run IE11, Edge, or Safari, you'll need to add this parameter before you can run"
              allowCustom: false
              values:
                - 'true'
                - 'false'
            DEBUG_MODE:
              default: false
              description: "Check here for echoing tests command"
              allowCustom: false
              values:
                - 'true'
                - 'false'
            JP_WORKSPACE: "/workspace"
            TESTIM_TOKEN: "7Gohf81BZYRrIMLoGBhnNF4wuzCS6is194r0R6Y8NEBUPBBPx5"
            TESTIM_PROJECT: "QCmTIpKSP0XtVRAGVTzU"
            TESTIM_GRID: "Testim-Grid"
          
    steps:
      - name: RunTestimTests
        type: Bash
        execution:
          onExecute:
            - echo "Running Testim Tests"
            - echo $JP_WORKSPACE
            - mkdir -p "${JP_WORKSPACE}/.npm-packages"
            - prefix="${JP_WORKSPACE}/.npm-packages"
            - NPM_PACKAGES="${JP_WORKSPACE}/.npm-packages"
            - export PATH="$PATH:$NPM_PACKAGES/bin"
            - export NODE_PATH="$NODE_PATH:$NPM_PACKAGES/lib/node_modules"
            - npm config set prefix "${JP_WORKSPACE}/.npm-packages"
            - npm install -g @testim/testim-cli
            - testim --token "${TESTIM_TOKEN}" --project "${TESTIM_PROJECT}" --grid "${TESTIM_GRID}" --report-file "testim-tests-report.xml"
            - echo "Testim finished"
